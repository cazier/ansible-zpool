present/absent:
  - name: create
    pool_name: test
    tasks:
      - name: zpool
        hosts: all
        tasks:
          - name: create
            become: true
            cazier.zfs.zpool:
              name: test
              zpool:
                storage:
                  - type: raidz1
                    disks:
                      - <__PATH__>/01.raw
                      - <__PATH__>/02.raw
                      - <__PATH__>/03.raw

                  - type: raidz1
                    disks:
                      - <__PATH__>/04.raw
                      - <__PATH__>/05.raw
                      - <__PATH__>/06.raw
              state: present
    result:
      failure: false
      exists: true

  - name: destroy unsuccessfully
    pool_name: test
    tasks:
      - name: zpool
        hosts: all
        tasks:
          - name: destroy
            become: true
            cazier.zfs.zpool:
              name: test
              zpool:
                storage:
                  - type: raidz1
                    disks:
                      - <__PATH__>/01.raw
                      - <__PATH__>/02.raw
                      - <__PATH__>/03.raw

                  - type: raidz1
                    disks:
                      - <__PATH__>/04.raw
                      - <__PATH__>/05.raw
                      - <__PATH__>/06.raw
              state: absent
    result:
      failure: true
      message: The zpool test exists, but cannot be destroyed without the `force` flag
      exists: true

  - name: destroy successfully
    pool_name: test
    tasks:
      - name: zpool
        hosts: all
        tasks:
          - name: destroy
            become: true
            cazier.zfs.zpool:
              name: test
              zpool:
                storage:
                  - type: raidz1
                    disks:
                      - <__PATH__>/01.raw
                      - <__PATH__>/02.raw
                      - <__PATH__>/03.raw

                  - type: raidz1
                    disks:
                      - <__PATH__>/04.raw
                      - <__PATH__>/05.raw
                      - <__PATH__>/06.raw
              state: absent
              force: true
    result:
      failure: false
      exists: false

options:
  - name: zpool with options
    pool_name: test
    tasks:
      - name: zpool
        hosts: all
        tasks:
          - name: create
            become: true
            cazier.zfs.zpool:
              name: test
              zpool:
                storage:
                  - type: raidz1
                    disks:
                      - <__PATH__>/01.raw
                      - <__PATH__>/02.raw
                      - <__PATH__>/03.raw

                  - type: raidz1
                    disks:
                      - <__PATH__>/04.raw
                      - <__PATH__>/05.raw
                      - <__PATH__>/06.raw
                options: &options
                  - ashift: '12'
              state: present
    result:
      failure: false
      exists: true
      options: *options

filters:
  - name: snapshots
    pool_name: test_filter
    vars:
      snapshots: &snapshots
        - '@all'

    tasks:
      - name: zpool
        hosts: all
        tasks:
          - name: create
            become: true
            cazier.zfs.zpool:
              name: test_filter
              zpool:
                storage:
                  - type: raidz1
                    disks:
                      - <__PATH__>/01.raw
                      - <__PATH__>/02.raw
                      - <__PATH__>/03.raw

              state: present

          - name: Create filesystem(s)
            become: true
            community.general.zfs:
              name: test_filter/test
              state: present

          - name: Enable zpool snapshot
            become: true
            community.general.zfs:
              name: test_filter
              state: present
              extra_zfs_properties:
                com.sun:auto-snapshot: true

          - name: Configure snapshots on filesystems
            become: true
            community.general.zfs:
              name: test_filter/test
              state: present
              extra_zfs_properties: "{{ snapshots | cazier.zfs.snapshot }}"

    result:
      failure: false
      exists: true
      filters: *snapshots
